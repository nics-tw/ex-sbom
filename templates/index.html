<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ex-s</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
  </head>
  <body>
    <header class="bg-white shadow">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between"
      >
        <div class="flex items-center space-x-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-7 w-7 text-[#009999]"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L7.586 10 5.293 7.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h3a1 1 0 100-2h-3z"
              clip-rule="evenodd"
            />
          </svg>
          <h1 class="text-2xl font-bold text-gray-800 tracking-tight">ex-s</h1>
        </div>
        <div class="text-sm text-gray-600">
          SBOM Explorer, designed by NICS-ra
        </div>
      </div>
    </header>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex items-start">
        <div>
          <input
            type="file"
            id="sbom-file-input"
            class="hidden"
            multiple
            accept=".json,.xml,.spdx"
          />

          <button
            id="select-sbom-btn"
            class="select-btn bg-[#009999] hover:bg-[#19a3a3] text-white font-medium py-2 px-4 rounded-md shadow transition duration-200 flex items-center space-x-2 focus:outline-none focus:ring-2 focus:ring-blue-300"
            onclick="document.getElementById('sbom-file-input').click()"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
              />
            </svg>
            <span>Select SBOM Files</span>
          </button>
        </div>

        <!-- File list container -->
        <div id="selected-files" class="ml-6 mt-1 text-gray-700"></div>
      </div>

      <!-- Upload status container -->
      <div id="upload-status" class="mt-4"></div>
    </div>

    <script>
      document
        .getElementById("sbom-file-input")
        .addEventListener("change", async function (e) {
          const fileList = e.target.files;
          const selectedFilesContainer = document.getElementById("selected-files");
          const statusContainer = document.getElementById("upload-status");
          
          // Clear the status container for new uploads
          statusContainer.innerHTML = "";
          
          // Display selected files
          selectedFilesContainer.innerHTML = "";
          
          if (fileList.length > 0) {
            const fileListHeading = document.createElement("div");
            fileListHeading.className = "font-medium mb-2";
            fileListHeading.textContent = "Selected files:";
            selectedFilesContainer.appendChild(fileListHeading);

            const fileListElement = document.createElement("ul");
            fileListElement.className = "space-y-1";

            Array.from(fileList).forEach((file) => {
              const listItem = document.createElement("li");
              listItem.className = "flex items-center";

              const icon = document.createElement("span");
              icon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[#009999] mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                </svg>
              `;

              const fileName = document.createElement("span");
              fileName.textContent = file.name;
              listItem.appendChild(icon);
              listItem.appendChild(fileName);
              fileListElement.appendChild(listItem);
            });

            selectedFilesContainer.appendChild(fileListElement);
            
            // Create status list for uploads
            const statusList = document.createElement("ul");
            statusList.className = "space-y-2 mt-4";
            statusContainer.appendChild(statusList);
            
            // Disable select button during upload
            const selectButton = document.getElementById("select-sbom-btn");
            selectButton.disabled = true;
            selectButton.classList.add("opacity-50", "cursor-not-allowed");
            
            // Process each file
            for (const file of fileList) {
              const statusItem = document.createElement("li");
              statusItem.className = "flex items-center";
              statusItem.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                </svg>
                <span>Uploading ${file.name}...</span>
              `;
              statusList.appendChild(statusItem);

              try {
                // Read file content
                const content = await readFileAsText(file);

                // Upload to server
                const response = await fetch(
                  "/sbom/upload?name=" + encodeURIComponent(file.name),
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: content,
                  }
                );

                if (response.ok) {
                  // Success
                  statusItem.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span>${file.name} uploaded successfully</span>
                  `;
                } else {
                  // Error
                  const errorData = await response.json();
                  statusItem.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-red-600">${file.name}: ${
                      errorData.error || "Upload failed"
                    }</span>
                  `;
                }
              } catch (error) {
                // Error reading or uploading file
                statusItem.innerHTML = `
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                  </svg>
                  <span class="text-red-600">${file.name}: ${
                    error.message || "Error reading file"
                  }</span>
                `;
              }
            }
            
            // Re-enable select button after uploads
            selectButton.disabled = false;
            selectButton.classList.remove("opacity-50", "cursor-not-allowed");
          }
        });

      // Helper function to read file as text
      function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error("Error reading file"));
          reader.readAsText(file);
        });
      }
    </script>
  </body>
</html>
