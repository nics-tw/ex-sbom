<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ex-s</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <style>
      .tab-active {
        border-bottom: 2px solid #009999;
        background-color: rgba(0, 153, 153, 0.1);
      }

      .language-btn {
        transition: all 0.2s;
      }

      .language-btn:hover {
        background-color: rgba(0, 153, 153, 0.1);
      }

      .active-language {
        background-color: rgba(0, 153, 153, 0.2);
        color: #009999;
      }
    </style>
  </head>
  <body>
    <header class="bg-white shadow">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between"
      >
        <div class="flex items-center space-x-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-7 w-7 text-[#009999]"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L7.586 10 5.293 7.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h3a1 1 0 100-2h-3z"
              clip-rule="evenodd"
            />
          </svg>
          <h1
            class="text-2xl font-bold text-gray-800 tracking-tight"
            data-i18n="appTitle"
          >
            ex-s
          </h1>
        </div>

        <div class="flex items-center space-x-3">
          <!-- Language switcher -->
          <div class="flex text-sm">
            <button
              id="lang-en"
              class="px-2 py-1 rounded font-medium language-btn active-language"
              onclick="changeLanguage('en')"
            >
              EN
            </button>
            <button
              id="lang-zh"
              class="px-2 py-1 rounded font-medium language-btn"
              onclick="changeLanguage('zh')"
            >
              正體中文
            </button>
          </div>

          <button
            id="tutorial-btn"
            class="px-3 py-1 bg-[#009999] hover:bg-[#19a3a3] text-white rounded text-sm flex items-center"
            onclick="window.location.href='/tutorial'"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 mr-1"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                clip-rule="evenodd"
                fill-rule="evenodd"
              />
            </svg>
            <span data-i18n="tutorialBtn">Tutorial</span>
          </button>

          <!-- Divider -->
          <div class="text-gray-400">|</div>

          <!-- App description -->
          <div
            class="text-sm text-gray-600"
            id="app-description"
            data-i18n="appDescription"
          >
            SBOM Explorer, designed by NICS-ra
          </div>
        </div>
      </div>
    </header>

    <!-- Update the upload section -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex items-start">
        <div>
          <input
            type="file"
            id="sbom-file-input"
            class="hidden"
            multiple
            accept=".json,.xml,.spdx"
          />
          <button
            id="select-sbom-btn"
            class="select-btn bg-[#009999] hover:bg-[#19a3a3] text-white font-medium py-2 px-4 rounded-md shadow transition duration-200 flex items-center space-x-2 focus:outline-none focus:ring-2 focus:ring-blue-300"
            onclick="document.getElementById('sbom-file-input').click()"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
              />
            </svg>
            <span data-i18n="selectFiles">Select SBOM Files</span>
          </button>
        </div>

        <!-- File list container -->
        <div id="selected-files" class="ml-6 mt-1 text-gray-700"></div>
      </div>

      <!-- Upload status container -->
      <div id="upload-status" class="mt-4"></div>

      <!-- Tabs container -->
      <div class="mt-6 border-b border-gray-200">
        <div
          class="text-lg font-medium text-gray-700 mb-2"
          data-i18n="uploadedFiles"
        >
          Uploaded SBOM Files
        </div>
        <div id="file-tabs" class="flex flex-wrap"></div>
      </div>

      <!-- Tab content area -->
      <div id="tab-content" class="py-4">
        <div
          id="no-tabs-message"
          class="text-gray-500 italic"
          data-i18n="noFilesUploaded"
        >
          No files uploaded yet
        </div>
      </div>
    </div>

    <script>
      // Track uploaded files
      const uploadedFiles = new Set();
      let activeTab = null;

      // Language translations
      const translations = {
        en: {
          appTitle: "ex-s",
          appDescription: "SBOM Explorer, designed by NICS-ra",
          selectFiles: "Select SBOM Files",
          selectedFiles: "Selected files:",
          uploadedFiles: "Uploaded SBOM Files",
          noFilesUploaded: "No files uploaded yet",
          uploading: "Uploading {0}...",
          uploadedSuccessfully: "{0} uploaded successfully",
          uploadFailed: "{0}: {1}",
          errorReadingFile: "Error reading file",
          warningOverwrite:
            "Warning: the previous <strong>{0}</strong> will be overwritten since the file names are same.",
          delete: "Delete",
          deletedSuccessfully: "{0} deleted successfully",
          errorDeleting: "Error deleting file: {0}",
          failedToDelete: "Failed to delete file: {0}",
          loadingTopology: "Loading topology data...",
          failedToLoadTopology: "Failed to load topology data",
          noTopologyData: "No topology data available for this SBOM",
          rootLevel: "Root Level",
          level: "Level {0}",
          topLevelDependencies:
            "(Top-level dependencies, which is directly import as package/component)",
          componentsCount: "({0} components)",
          vulnerabilities: "{0} vulnerabilities",
          noVulnerabilities: "No vulnerabilities",
          noComponents: "No components at this level",
          showAll: "Show all {0} components",
          showLess: "Show less",
          unknownError: "Unknown error occurred",
          componentDetails: "Component Details",
          componentName: "Component Name",
          componentVersion: "Version",
          vulnerabilityCount: "Vulnerabilities of this component",
          noVulnerabilitiesFound: "No vulnerabilities found for this component",
          vulnerabilityId: "Vulnerability ID",
          cvssScore: "CVSS Score",
          severity: "Severity",
          summary: "Summary",
          details: "Details",
          fixVersion: "Suggest Fix Version",
          otherFixVersions: "Other Available Fix Versions",
          close: "Close",
          loading: "Loading...",
          tutorialBtn: "Tutorial",
          backToMain: "Back to Main",
          dependencyVulnPaths: "Dependency Vulnerability Paths",
          vulnerablePath: "Vulnerability Path {0}",
          vulnerableComponent: "(Vulnerable)",
          suggestUpgradeTo: "Suggest upgrade to version {0}",
          breakingChangeWarning: "Warning: Updating to version {0} includes breaking changes that may require code modifications.",
          severeVulnWarning:
            "This component contains security vulnerabilities with a CVSS score of 7.0 or higher. The suggested fix version is based on these vulnerabilities.",
        },
        zh: {
          appTitle: "ex-s",
          appDescription: "SBOM explorer，由 NICS-ra 設計",
          selectFiles: "選擇 SBOM 檔案",
          selectedFiles: "已選擇的檔案：",
          uploadedFiles: "已上傳的 SBOM 檔案",
          noFilesUploaded: "尚未上傳檔案",
          uploading: "正在上傳 {0}...",
          uploadedSuccessfully: "{0} 上傳成功",
          uploadFailed: "{0}: {1}",
          errorReadingFile: "讀取檔案錯誤",
          warningOverwrite:
            "警告：由於檔案名稱相同，之前的 <strong>{0}</strong> 將被覆蓋。",
          delete: "刪除",
          deletedSuccessfully: "{0} 刪除成功",
          errorDeleting: "刪除檔案錯誤: {0}",
          failedToDelete: "刪除檔案失敗: {0}",
          loadingTopology: "正在處理...",
          failedToLoadTopology: "資料處理失敗",
          noTopologyData: "此 SBOM 沒有足夠的相關資料",
          rootLevel: "直接使用之元件",
          level: "第 {0} 級",
          topLevelDependencies:
            "（被直接使用於應用程式之元件、工具、或者套件）",
          componentsCount: "（{0} 個元件）",
          vulnerabilities: "{0} 個漏洞",
          noVulnerabilities: "沒有漏洞",
          noComponents: "此層沒有任何元件",
          showAll: "顯示所有 {0} 個元件",
          showLess: "顯示較少",
          unknownError: "發生錯誤",
          componentDetails: "元件詳細資訊",
          componentName: "元件名稱",
          componentVersion: "版本",
          vulnerabilityCount: "此元件漏洞數量",
          noVulnerabilitiesFound: "此元件無已知漏洞",
          vulnerabilityId: "漏洞 ID",
          cvssScore: "CVSS 評分",
          severity: "嚴重程度",
          summary: "摘要",
          details: "詳細資訊",
          fixVersion: "建議修復版本",
          otherFixVersions: "其他可用修復版本",
          close: "關閉",
          loading: "載入中...",
          tutorialBtn: "使用教學",
          backToMain: "返回主頁",
          dependencyVulnPaths: "相依性漏洞路徑",
          vulnerablePath: "漏洞路徑 {0}",
          vulnerableComponent: "(有漏洞)",
          suggestUpgradeTo: "建議升級到版本 {0}",
          breakingChangeWarning: "警告：升級到版本 {0} 包含破壞性改動，請依個別情況判斷是否需調整相關程式碼。",
          severeVulnWarning: "此元件內包含 CVSS 評分為 7.0 或以上之資安漏洞，建議修正版本為基於此漏洞計算而來",
        },
      };

      document
        .getElementById("sbom-file-input")
        .addEventListener("change", async function (e) {
          // Existing file upload code remains the same
          const fileList = e.target.files;
          const selectedFilesContainer =
            document.getElementById("selected-files");
          const statusContainer = document.getElementById("upload-status");

          statusContainer.innerHTML = "";
          selectedFilesContainer.innerHTML = "";

          if (fileList.length > 0) {
            const fileListHeading = document.createElement("div");
            fileListHeading.className = "font-medium mb-2";
            fileListHeading.textContent = t("selectedFiles");
            selectedFilesContainer.appendChild(fileListHeading);

            const fileListElement = document.createElement("ul");
            fileListElement.className = "space-y-1";

            Array.from(fileList).forEach((file) => {
              const listItem = document.createElement("li");
              listItem.className = "flex items-center";

              const icon = document.createElement("span");
              icon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[#009999] mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 011 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                </svg>
              `;

              const fileName = document.createElement("span");
              fileName.textContent = file.name;
              listItem.appendChild(icon);
              listItem.appendChild(fileName);
              fileListElement.appendChild(listItem);
            });

            selectedFilesContainer.appendChild(fileListElement);

            const statusList = document.createElement("ul");
            statusList.className = "space-y-2 mt-4";
            statusContainer.appendChild(statusList);

            const selectButton = document.getElementById("select-sbom-btn");
            selectButton.disabled = true;
            selectButton.classList.add("opacity-50", "cursor-not-allowed");

            for (const file of fileList) {
              const statusItem = document.createElement("li");
              statusItem.className = "flex items-center";
              statusItem.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                </svg>
                <span>${t("uploading", file.name)}</span>
              `;
              statusList.appendChild(statusItem);

              // Check if we're overwriting an existing file
              const isOverwriting = uploadedFiles.has(file.name);

              // If overwriting, show the warning message
              if (isOverwriting) {
                const warningItem = document.createElement("li");
                warningItem.className =
                  "flex items-center bg-yellow-50 px-4 py-2 rounded-md border border-yellow-200 mt-2";
                warningItem.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-600 mr-2" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
      </svg>
      <span class="text-yellow-800">${t("warningOverwrite", file.name)}</span>
    `;
                statusList.appendChild(warningItem);

                // Remove the warning after 15 seconds
                setTimeout(() => {
                  warningItem.classList.add(
                    "transition-opacity",
                    "duration-500",
                    "opacity-0"
                  );
                  setTimeout(() => {
                    warningItem.remove();
                  }, 500);
                }, 15000);
              }

              try {
                const content = await readFileAsText(file);
                const response = await fetch(
                  "/sbom/upload?name=" + encodeURIComponent(file.name),
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: content,
                  }
                );

                if (response.ok) {
                  // Get the response data which contains the file name
                  const responseData = await response.json();
                  const fileName = responseData.data?.name || file.name;

                  statusItem.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-green-600">${t(
                      "uploadedSuccessfully",
                      file.name
                    )}</span>
                    `;

                  // Add a tab for the uploaded file
                  addFileTab(fileName);

                  // remove the uploading status after 3 seconds
                  setTimeout(() => {
                    statusItem.remove();
                  }, 3000);
                } else {
                  // Error handling remains the same
                  const errorData = await response.json();
                  statusItem.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm8.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 00-1.414 1.414L10 11.414l1.293 1.293a1 1 001.414-1.414L11.414 10l1.293-1.293a1 1 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-red-600">${t(
                      "uploadFailed",
                      file.name,
                      errorData.error || "Upload failed"
                    )}</span>
                  `;
                }
              } catch (error) {
                // Error reading or uploading file - same as before
                statusItem.innerHTML = `
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 000 16zm8.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 00-1.414 1.414L10 11.414l1.293 1.293a1 1 001.414-1.414L11.414 10l1.293-1.293a1 1 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                  </svg>
                  <span class="text-red-600">${t(
                    "uploadFailed",
                    file.name,
                    error.message || t("errorReadingFile")
                  )}</span>
                `;
              }
            }

            // Re-enable select button after uploads
            selectButton.disabled = false;
            selectButton.classList.remove("opacity-50", "cursor-not-allowed");
          }
        });

      // Current language
      let currentLanguage = "en";

      // Function to replace placeholders in translations
      function formatString(str, ...args) {
        return str.replace(/{(\d+)}/g, (match, index) => {
          return typeof args[index] !== "undefined" ? args[index] : match;
        });
      }

      // Add this function to render markdown content
      function renderMarkdown(markdown) {
        if (!markdown) return "";

        // Basic markdown rendering (for a more complete solution, consider using a library like marked.js)
        return (
          markdown
            // Headers
            .replace(
              /^### (.*$)/gm,
              '<h3 class="text-lg font-medium mt-3 mb-2">$1</h3>'
            )
            .replace(
              /^## (.*$)/gm,
              '<h2 class="text-xl font-medium mt-4 mb-2">$1</h2>'
            )
            .replace(
              /^# (.*$)/gm,
              '<h1 class="text-2xl font-bold mt-4 mb-3">$1</h1>'
            )
            // Bold
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            // Italic
            .replace(/\*(.*?)\*/g, "<em>$1</em>")
            // Code blocks
            .replace(
              /```([\s\S]*?)```/g,
              '<pre class="bg-gray-100 p-2 rounded my-2 overflow-x-auto text-sm"><code>$1</code></pre>'
            )
            // Inline code
            .replace(
              /`(.*?)`/g,
              '<code class="bg-gray-100 px-1 rounded text-sm">$1</code>'
            )
            // Links
            .replace(
              /\[(.*?)\]\((.*?)\)/g,
              '<a href="$2" target="_blank" class="text-blue-600 hover:underline">$1</a>'
            )
            // Lists
            .replace(/^\s*-\s(.*$)/gm, '<li class="ml-4">$1</li>')
            // Paragraphs
            .replace(/^\s*(\n)?([^\n]+)/gm, function (m) {
              return /^<(\/)?(h1|h2|h3|pre|li)/i.test(m)
                ? m
                : '<p class="my-2">' + m + "</p>";
            })
            // Clean up empty paragraphs
            .replace(/<p><\/p>/g, "")
        );
      }

      // Function to get translated text
      function t(key, ...args) {
        const translation =
          translations[currentLanguage][key] || translations["en"][key] || key;
        return formatString(translation, ...args);
      }

      // Function to change language
      function changeLanguage(lang) {
        currentLanguage = lang;
        document
          .getElementById("lang-en")
          .classList.toggle("active-language", lang === "en");
        document
          .getElementById("lang-zh")
          .classList.toggle("active-language", lang === "zh");

        // Update all text elements with data-i18n attribute
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          let args = [];
          if (el.hasAttribute("data-i18n-args")) {
            try {
              args = JSON.parse(el.getAttribute("data-i18n-args"));
            } catch (e) {
              console.error("Invalid i18n args", e);
            }
          }
          el.innerHTML = t(key, ...args);
        });

        // Update app description
        document.getElementById("app-description").textContent =
          t("appDescription");

        // Update select button text
        const selectBtn = document.querySelector("#select-sbom-btn span");
        if (selectBtn) selectBtn.textContent = t("selectFiles");

        // Update "no files" message
        const noFilesMsg = document.getElementById("no-tabs-message");
        if (noFilesMsg) noFilesMsg.textContent = t("noFilesUploaded");

        // Update uploaded files heading
        const uploadedFilesHeading = document.querySelector(".mt-6 .text-lg");
        if (uploadedFilesHeading)
          uploadedFilesHeading.textContent = t("uploadedFiles");

        // Refresh current view if tab is active
        if (activeTab) {
          fetchTopologyData(activeTab.dataset.fileName);
        }
      }

      // Function to add a new file tab
      function addFileTab(fileName) {
        const tabsContainer = document.getElementById("file-tabs");
        const noTabsMessage = document.getElementById("no-tabs-message");

        // Hide the "no files" message
        if (noTabsMessage) {
          noTabsMessage.style.display = "none";
        }

        // Check if we already have this file
        if (uploadedFiles.has(fileName)) {
          // Find the existing tab
          const existingTab = Array.from(tabsContainer.children).find(
            (tab) => tab.dataset.fileName === fileName
          );

          // Select the existing tab
          if (existingTab) {
            selectTab(existingTab);
          }

          return;
        }

        // Add to tracked files
        uploadedFiles.add(fileName);

        // Create the tab element
        const tab = document.createElement("div");
        tab.className =
          "px-4 py-2 border border-gray-300 rounded-t-md mr-2 mb-2 cursor-pointer hover:bg-gray-50 flex items-center";
        tab.dataset.fileName = fileName;

        // Tab content
        tab.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[#009999] mr-2" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
    </svg>
    <span>${fileName}</span>
  `;

        // Add click event to select the tab
        tab.addEventListener("click", () => selectTab(tab));

        // Add the tab to the container
        tabsContainer.appendChild(tab);

        // Always select the newly added tab
        selectTab(tab);
      }

      // Function to select a tab
      function selectTab(tabElement) {
        const tabsContainer = document.getElementById("file-tabs");
        const tabContent = document.getElementById("tab-content");
        const fileName = tabElement.dataset.fileName;

        // Remove active class from all tabs
        tabsContainer.querySelectorAll("div").forEach((tab) => {
          tab.classList.remove("tab-active");
        });

        // Add active class to selected tab
        tabElement.classList.add("tab-active");

        // Show loading state
        tabContent.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <div class="text-lg font-medium">${fileName}</div>
      <button 
        class="delete-btn bg-[#E46058] hover:bg-red-600 text-white py-1 px-3 rounded text-sm flex items-center"
        onclick="deleteFile('${fileName}')"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
        ${t("delete")}
      </button>
    </div>
    <div class="mt-4 text-gray-600 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-5 w-5 mr-3 text-[#009999]" viewBox="0 0 24 24" fill="none">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      ${t("loadingTopology")}
    </div>
  `;

        // Store the active tab
        activeTab = tabElement;

        // Fetch topology data
        fetchTopologyData(fileName);
      }

      // Add a new function to fetch topology data
      async function fetchTopologyData(fileName) {
        try {
          const response = await fetch(
            `/topology/get_list_by_level?name=${encodeURIComponent(fileName)}`
          );

          if (!response.ok) {
            throw new Error(`Failed to fetch topology: ${response.status}`);
          }

          const responseData = await response.json();

          if (responseData.data) {
            displayTopologyData(responseData.data, fileName);
          } else {
            throw new Error("No topology data available");
          }
        } catch (error) {
          console.error("Error fetching topology:", error);

          const tabContent = document.getElementById("tab-content");
          const headerDiv = tabContent.querySelector("div:first-child");

          // Keep the header with delete button
          tabContent.innerHTML = "";
          tabContent.appendChild(headerDiv);

          // Show error message
          const errorDiv = document.createElement("div");
          errorDiv.className = "mt-4 p-4 bg-red-50 text-red-600 rounded-md";
          errorDiv.innerHTML = `
      <div class="font-medium">Failed to load topology data</div>
      <div class="text-sm mt-1">${error.message || t("unknownError")}</div>
    `;
          tabContent.appendChild(errorDiv);
        }
      }

      // Function to display topology data
      function displayTopologyData(topologyData, fileName) {
        const tabContent = document.getElementById("tab-content");
        const headerDiv = tabContent.querySelector("div:first-child");

        // Keep the header with delete button
        tabContent.innerHTML = "";
        tabContent.appendChild(headerDiv);

        // Create container for topology data
        const topologyContainer = document.createElement("div");
        topologyContainer.className = "mt-6";

        // Sort levels by level number
        const sortedLevels = topologyData.sort((a, b) => a.level - b.level);

        if (sortedLevels.length === 0) {
          const emptyState = document.createElement("div");
          emptyState.className = "text-gray-500 italic";
          emptyState.textContent = t("noTopologyData");
          topologyContainer.appendChild(emptyState);
        } else {
          // Create level panels
          sortedLevels.forEach((level) => {
            const levelPanel = document.createElement("div");
            levelPanel.className =
              "mb-6 border border-gray-200 rounded-md overflow-hidden";

            // Level header
            const levelHeader = document.createElement("div");
            levelHeader.className =
              "bg-gray-50 px-4 py-3 flex items-center justify-between cursor-pointer";

            // Add click event for folding/unfolding
            const componentCount = level.components.length;
            const hasLotsOfComponents = componentCount > 10;

            const levelTitle = document.createElement("div");
            levelTitle.className = "font-medium";
            // Use translation for level titles
            if (level.level === 0) {
              levelTitle.innerHTML = `${t(
                "rootLevel"
              )} <span class="text-sm font-normal text-gray-500">${t(
                "topLevelDependencies"
              )}</span>`;
            } else {
              levelTitle.innerHTML = `${t(
                "level",
                level.level
              )} <span class="text-sm font-normal text-gray-500">${t(
                "componentsCount",
                componentCount
              )}</span>`;
            }

            const rightSection = document.createElement("div");
            rightSection.className = "flex items-center space-x-2";

            const vulnBadge = document.createElement("div");
            if (level.total_vulns > 0) {
              vulnBadge.className =
                "px-2 py-1 text-xs font-medium bg-[#D9936E] text-red-800 rounded-full";
              vulnBadge.textContent = t("vulnerabilities", level.total_vulns);
            } else {
              vulnBadge.className =
                "px-2 py-1 text-xs font-medium bg-[#95D0C0] text-[#231815] rounded-full";
              vulnBadge.textContent = t("noVulnerabilities");
            }

            // Fold/Unfold icon
            const foldIcon = document.createElement("span");
            foldIcon.className = "text-gray-500";
            foldIcon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      `;

            rightSection.appendChild(vulnBadge);
            rightSection.appendChild(foldIcon);

            levelHeader.appendChild(levelTitle);
            levelHeader.appendChild(rightSection);
            levelPanel.appendChild(levelHeader);

            // Components list container
            const componentsList = document.createElement("div");
            componentsList.className = "px-4 py-3";
            componentsList.dataset.isExpanded = "true";

            if (componentCount === 0) {
              const noComponentsMsg = document.createElement("div");
              noComponentsMsg.className = "text-gray-500 italic";
              noComponentsMsg.textContent = t("noComponents");
              componentsList.appendChild(noComponentsMsg);
            } else {
              const componentsGrid = document.createElement("div");
              componentsGrid.className =
                "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2";

              // Function to render components
              const renderComponents = (showAll) => {
                componentsGrid.innerHTML = "";
                const displayComponents = showAll
                  ? level.components
                  : level.components.slice(0, 10);

                displayComponents.forEach((component) => {
                  const componentItem = document.createElement("div");

                  // Check if component has direct vulnerabilities
                  const hasVuln =
                    Array.isArray(level.components_with_vuln) &&
                    level.components_with_vuln.includes(component);

                  // Check if component has dependencies with vulnerabilities
                  const hasVulnDep =
                    Array.isArray(level.components_with_vuln_dep) &&
                    level.components_with_vuln_dep.includes(component) &&
                    !hasVuln; // Only mark as dependency vuln if not already marked as direct vuln

                  // Apply appropriate styling based on vulnerability status
                  if (hasVuln) {
                    // Direct vulnerability - red styling (keep existing)
                    componentItem.className =
                      "px-3 py-2 border border-red-200 bg-red-50 rounded flex items-center cursor-pointer";
                  } else if (hasVulnDep) {
                    // Dependency has vulnerability - yellow styling
                    componentItem.className =
                      "px-3 py-2 border border-yellow-200 bg-yellow-50 rounded flex items-center cursor-pointer";
                  } else {
                    // No vulnerabilities - default styling
                    componentItem.className =
                      "px-3 py-2 border border-gray-200 bg-white rounded flex items-center cursor-pointer";
                  }

                  // Select appropriate icon based on vulnerability status
                  let icon;
                  if (hasVuln) {
                    // Red warning icon for direct vulnerabilities
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
    </svg>`;
                  } else if (hasVulnDep) {
                    // Yellow warning icon for dependency vulnerabilities
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
    </svg>`;
                  } else {
                    // Default component icon for no vulnerabilities
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 mr-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 01-1 1h-2a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd" />
    </svg>`;
                  }

                  componentItem.innerHTML = `${icon}<span class="truncate">${component}</span>`;

                  // Add click event to show component details
                  componentItem.addEventListener("click", (e) => {
                    e.stopPropagation(); // Prevent level panel from toggling
                    showComponentDetails(fileName, component);
                  });

                  componentsGrid.appendChild(componentItem);
                });

                // Add "Show more" / "Show less" button if needed
                if (hasLotsOfComponents) {
                  const toggleButton = document.createElement("button");
                  toggleButton.className =
                    "mt-4 text-sm text-[#009999] hover:text-[#CCCC00] font-medium flex items-center";

                  if (showAll) {
                    toggleButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M14.707 12.707a1 1 01-1.414 0L10 9.414l-3.293-3.293a1 1 011.414 1.414l-4 4a1 1 01-1.414 0l-4-4a1 1 010-1.414z" clip-rule="evenodd" />
                </svg>
                ${t("showLess")}
              `;
                    toggleButton.onclick = () => renderComponents(false);
                  } else {
                    toggleButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 011.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                ${t("showAll", componentCount)}
              `;
                    toggleButton.onclick = () => renderComponents(true);
                  }

                  componentsGrid.appendChild(toggleButton);
                }
              };

              // Initial rendering
              renderComponents(false);
              componentsList.appendChild(componentsGrid);
            }

            // Add click event to toggle visibility
            levelHeader.addEventListener("click", () => {
              const isExpanded = componentsList.dataset.isExpanded === "true";

              // Toggle visibility
              if (isExpanded) {
                componentsList.style.display = "none";
                componentsList.dataset.isExpanded = "false";
                foldIcon.querySelector("svg").classList.add("-rotate-90");
              } else {
                componentsList.style.display = "block";
                componentsList.dataset.isExpanded = "true";
                foldIcon.querySelector("svg").classList.remove("-rotate-90");
              }
            });

            levelPanel.appendChild(componentsList);
            topologyContainer.appendChild(levelPanel);
          });
        }

        tabContent.appendChild(topologyContainer);
      }

      // Function to show component details modal
      async function showComponentDetails(fileName, component) {
        // Create modal container if it doesn't exist
        if (!document.getElementById("component-modal")) {
          const modal = document.createElement("div");
          modal.id = "component-modal";
          modal.className =
            "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden";
          modal.innerHTML = `
      <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[85vh] flex flex-col">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
          <h2 class="text-xl font-medium text-gray-800" id="component-modal-title">${t(
            "componentDetails"
          )}</h2>
          <button id="component-modal-close" class="text-gray-500 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="overflow-y-auto flex-1 p-6" id="component-modal-content">
          <div class="flex justify-center items-center py-8">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-[#009999]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>${t("loading")}</span>
          </div>
        </div>
      </div>
    `;
          document.body.appendChild(modal);

          // Add close event
          document
            .getElementById("component-modal-close")
            .addEventListener("click", () => {
              document
                .getElementById("component-modal")
                .classList.add("hidden");
            });
        }

        // Update modal title and show it
        document.getElementById("component-modal-title").textContent =
          component;
        document.getElementById("component-modal").classList.remove("hidden");

        // Reset modal content to loading state
        document.getElementById("component-modal-content").innerHTML = `
    <div class="flex justify-center items-center py-8">
      <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-[#009999]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>${t("loading")}</span>
    </div>
  `;

        // Fetch component data
        try {
          const [componentResponse, vulnDepResponse] = await Promise.all([
            fetch(
              `/topology/component?name=${encodeURIComponent(
                fileName
              )}&component=${encodeURIComponent(component)}`
            ),
            fetch(
              `/topology/get_component_vuln_dep?name=${encodeURIComponent(
                fileName
              )}&component=${encodeURIComponent(component)}`
            ),
          ]);

          if (!componentResponse.ok) {
            throw new Error(
              `Failed to fetch component details: ${componentResponse.status}`
            );
          }

          const componentData = await componentResponse.json();
          let vulnDepData = null;

          // Only process vulnerability dependency data if the request was successful
          if (vulnDepResponse.ok) {
            vulnDepData = await vulnDepResponse.json();
          }

          if (componentData.data) {
            renderComponentDetails(componentData.data, vulnDepData?.data || []);
          } else {
            throw new Error("No component data available");
          }
        } catch (error) {
          console.error("Error fetching component details:", error);
          document.getElementById("component-modal-content").innerHTML = `
      <div class="bg-red-50 text-red-800 p-4 rounded-md">
        <p class="font-medium">Error loading component details</p>
        <p class="mt-2">${error.message || "Unknown error"}</p>
      </div>
    `;
        }
      }

      // Function to render component details
      function renderComponentDetails(component, vulnDepPaths = []) {
        const content = document.getElementById("component-modal-content");
        const {
          name,
          version,
          vuln_number = 0,
          vulns = [],
          suggested_fix_version,
          is_breaking_change,
          has_severe_vuln,
        } = component;

        // Start with component metadata
        let html = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 pb-6 border-b border-gray-200">
      <div>
        <h3 class="text-sm font-medium text-gray-500">${t("componentName")}</h3>
        <p class="mt-2 text-lg">${name || "—"}</p>
      </div>
      <div>
        <h3 class="text-sm font-medium text-gray-500">${t(
          "componentVersion"
        )}</h3>
        <div class="mt-2 flex items-center">
          <span>${version || "—"}</span>
          ${
            suggested_fix_version
              ? `<div class="ml-3 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[#009999] mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
              </svg>
              <span class="text-[#009999] font-medium">${t("suggestUpgradeTo", suggested_fix_version)}</span>
            </div>`
              : ""
          }
        </div>
        ${
          is_breaking_change && suggested_fix_version
            ? `<div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm flex items-start">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500 mr-1 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-1-8a1 1 0 0 0-1 1v3a1 1 0 0 0 2 0V6a1 1 0 0 0-1-1z" clip-rule="evenodd" />
            </svg>
            <span class="text-yellow-700">${t(
              "breakingChangeWarning",
              suggested_fix_version
            )}</span>
          </div>`
            : ""
        }
        ${
          has_severe_vuln
            ? `<div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-sm flex items-start">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mr-1 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-1-8a1 1 0 0 0-1 1v3a1 1 0 0 0 2 0V6a1 1 0 0 0-1-1z" clip-rule="evenodd" />
            </svg>
            <span class="text-red-700">${t("severeVulnWarning")}</span>
          </div>`
            : ""
        }
      </div>
    </div>
  `;

        // Add vulnerability dependency paths section if available
        if (vulnDepPaths && vulnDepPaths.length > 0) {
          html += `
      <div class="mb-6 pb-6 border-b border-gray-200">
        <h3 class="text-md font-medium mb-3">${t("dependencyVulnPaths")}</h3>
        <div class="space-y-3">
    `;

          vulnDepPaths.forEach((path, index) => {
            html += `
        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-md">
          <div class="flex items-center mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            <span class="font-medium">${t("vulnerablePath", index + 1)}</span>
          </div>
          <div class="flex items-center flex-wrap ml-2">
      `;

            path.path.forEach((pathComponent, i) => {
              const isFirst = i === 0;
              const isLast = i === path.path.length - 1;
              const isVulnerable = pathComponent === path.end;

              if (i > 0) {
                html += `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 mx-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
            </svg>
          `;
              }

              html += `
          <span class="px-2 py-1 text-sm rounded ${
            isVulnerable
              ? "bg-red-100 text-red-800 font-medium"
              : "bg-gray-100 text-gray-800"
          }">
            ${pathComponent}${isVulnerable ? `` : ""}
          </span>
        `;
            });

            html += `
          </div>
        </div>
      `;
          });

          html += `
        </div>
      </div>
    `;
        }

        // Add vulnerabilities section if any
        html += `
    <div>
      <div class="flex items-center justify-between">
        <h3 class="text-md font-medium">${t("vulnerabilityCount")}</h3>
        ${
          vuln_number > 0
            ? `<span class="px-2.5 py-0.5 rounded-full text-sm font-medium bg-red-100 text-red-800">${vuln_number}</span>`
            : `<span class="px-2.5 py-0.5 rounded-full text-sm font-medium bg-green-100 text-green-800">${vuln_number}</span>`
        }
      </div>
  `;

        if (vulns && vulns.length > 0) {
          // Add collapsible vulnerabilities
          vulns.forEach((vuln, index) => {
            const vulnId = `vuln-${index}`;

            // Calculate severity from CVSS score
            const severityLevel = getSeverityFromCvss(vuln.cvss_score);
            const severityClass = getSeverityClass(severityLevel);

            html += `
              <div class="mt-4 border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-gray-50 px-4 py-3 flex items-center justify-between cursor-pointer" 
                     onclick="toggleVulnerabilityDetails('${vulnId}')">
                  <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">${vuln.id || "Unknown"}</span>
                  </div>
                  <div class="flex items-center">
                    ${
                      vuln.cvss_score
                        ? `<span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 mr-2">CVSS: ${vuln.cvss_score}</span>`
                        : ""
                    }
                    <span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${severityClass}">${severityLevel}</span>
                    <svg id="chevron-${vulnId}" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 transform transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                  </div>
                </div>
                <div id="${vulnId}" class="px-4 py-3 border-t border-gray-200 hidden">
                  ${
                    vuln.summary
                      ? `<div class="mb-4">
                      <h4 class="text-sm font-medium text-gray-500 mb-1">${t(
                        "summary"
                      )}</h4>
                      <p>${vuln.summary}</p>
                    </div>`
                      : ""
                  }
                  
                  ${
                    vuln.details
                      ? `<div class="mb-4">
                      <h4 class="text-sm font-medium text-gray-500 mb-1">${t(
                        "details"
                      )}</h4>
                      <div class="prose prose-sm max-w-none">${renderMarkdown(
                        vuln.details
                      )}</div>
                    </div>`
                      : ""
                  }
                  
                  ${
                    vuln.suggest_fix_version
                      ? `<div class="mt-2">
                      <h4 class="text-sm font-medium text-gray-500 mb-1">${t(
                        "fixVersion"
                      )}</h4>
                      <p class="text-green-600 font-medium">${
                        vuln.suggest_fix_version
                      }</p>
                    </div>`
                      : ""
                  }

                  ${
                    vuln.other_fix_versions
                      ? `<div class="mt-2">
      <h4 class="text-sm font-medium text-gray-500 mb-1">${t(
        "otherFixVersions"
      )}</h4>
      <p class="text-gray-800">${vuln.other_fix_versions}</p>
    </div>`
                      : ""
                  }
                </div>
              </div>
            `;
          });
        } else {
          html += `
      <div class="mt-4 text-gray-500 italic">
        ${t("noVulnerabilitiesFound")}
      </div>
    `;
        }

        html += "</div>";
        content.innerHTML = html;
      }

      // Helper function to get CSS class for severity level
      function getSeverityClass(severity) {
        const severityLower = severity.toLowerCase();
        if (severityLower.includes("critical")) {
          return "bg-red-100 text-red-800";
        } else if (severityLower.includes("high")) {
          return "bg-orange-100 text-orange-800";
        } else if (severityLower.includes("medium")) {
          return "bg-yellow-100 text-yellow-800";
        } else if (severityLower.includes("low")) {
          return "bg-blue-100 text-blue-800";
        } else {
          return "bg-gray-100 text-gray-800";
        }
      }

      // Function to toggle vulnerability details visibility
      function toggleVulnerabilityDetails(vulnId) {
        const detailsElem = document.getElementById(vulnId);
        const chevronElem = document.getElementById(`chevron-${vulnId}`);

        if (detailsElem.classList.contains("hidden")) {
          detailsElem.classList.remove("hidden");
          chevronElem.classList.add("rotate-180");
        } else {
          detailsElem.classList.add("hidden");
          chevronElem.classList.remove("rotate-180");
        }
      }

      // Make the toggle function available globally
      window.toggleVulnerabilityDetails = toggleVulnerabilityDetails;

      function getSeverityFromCvss(cvssScore) {
        if (!cvssScore) return "Unknown";

        const score = parseFloat(cvssScore);

        if (isNaN(score)) return "Unknown";

        if (score >= 9.0) return "Critical";
        if (score >= 7.0) return "High";
        if (score >= 4.0) return "Medium";
        if (score >= 0.1) return "Low";

        return "None";
      }

      // Function to delete a file
      async function deleteFile(fileName) {
        try {
          const response = await fetch(
            `/sbom/delete?name=${encodeURIComponent(fileName)}`,
            {
              method: "DELETE",
            }
          );

          if (response.ok) {
            // Remove the tab
            const tabsContainer = document.getElementById("file-tabs");
            const tabToRemove = tabsContainer.querySelector(
              `[data-file-name="${fileName}"]`
            );

            if (tabToRemove) {
              tabsContainer.removeChild(tabToRemove);
              uploadedFiles.delete(fileName);

              // Clear content if this was the active tab
              if (activeTab === tabToRemove) {
                document.getElementById("tab-content").innerHTML = "";
                activeTab = null;
              }

              // If there are other tabs, select the first one
              if (uploadedFiles.size > 0) {
                const firstTab = tabsContainer.querySelector("div");
                if (firstTab) {
                  selectTab(firstTab);
                }
              } else {
                // Show "no files" message
                document.getElementById("tab-content").innerHTML =
                  '<div id="no-tabs-message" class="text-gray-500 italic">No files uploaded yet</div>';
              }
            }

            // Reset file input to allow re-uploading the same file
            document.getElementById("sbom-file-input").value = "";

            // Show success message
            const statusContainer = document.getElementById("upload-status");
            const successMessage = document.createElement("div");
            successMessage.className = "mt-2 text-green-600 flex items-center";
            successMessage.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              ${t("deletedSuccessfully", fileName)}
            `;
            statusContainer.innerHTML = "";
            statusContainer.appendChild(successMessage);

            // Remove the message after 3 seconds
            setTimeout(() => {
              successMessage.remove();
            }, 3000);
          } else {
            // Handle error
            const errorData = await response.json();
            alert(t("errorDeleting", errorData.error || t("unknownError")));
          }
        } catch (error) {
          console.error("Error deleting file:", error);
          alert(t("failedToDelete", error.message || t("unknownError")));
        }
      }

      // Helper function to read file as text (keep the existing one)
      function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error("Error reading file"));
          reader.readAsText(file);
        });
      }

      // Initialize the language based on browser preference
      document.addEventListener("DOMContentLoaded", function () {
        // Check browser language preference
        const browserLang = navigator.language || navigator.userLanguage;
        if (browserLang.startsWith("zh")) {
          changeLanguage("zh");
        } else {
          changeLanguage("en");
        }
      });
    </script>
  </body>
</html>
